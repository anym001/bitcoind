name: Auto-create Version Branch

on:
  schedule:
    - cron: "1 7 * * *"
  workflow_dispatch:

jobs:
  create-branches:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq
        
    - name: Fetch latest Bitcoin Core releases
      id: releases
      run: |
        curl -s https://api.github.com/repos/bitcoin/bitcoin/releases \
          | jq -r '.[].tag_name' > tags.txt

        grep -E '^v([2-9][8-9]|[3-9][0-9])\.[0-9]+$' tags.txt | sort -V > filtered_tags.txt

        echo "Branches to build:"
        cat filtered_tags.txt

    - name: Create missing version branches
      run: |
        while read -r TAG; do
          [ -z "$TAG" ] && continue

          if git ls-remote --heads origin "$TAG" | grep "$TAG" >/dev/null; then
            echo "Branch $TAG exists â†’ OK"
            continue
          fi

          echo "Creating new version branch: $TAG"

          git checkout main
          git pull --rebase

          git checkout -b "$TAG"
          git push origin "$TAG"

          echo "Created and pushed $TAG"

        done < filtered_tags.txt
