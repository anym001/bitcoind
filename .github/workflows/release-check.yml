name: Check Bitcoin Core Releases

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check_releases:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get official releases and current releases
        id: versions
        run: |
          OFFICIAL_VERSIONS=$(curl -s https://api.github.com/repos/bitcoin/bitcoin/releases \
            | jq -r '.[].tag_name' \
            | grep -E '^v(2[8-9]|[3-9][0-9])\.[0-9]+$' \
            | grep -vE 'rc[0-9]+$' \
            | sed 's/^v//' \
            | sort -V \
            | tr '\n' ' ')

          LATEST_VERSION=$(curl -s https://api.github.com/repos/bitcoin/bitcoin/releases/latest \
            | jq -r '.tag_name' \
            | sed 's/^v//')

          CURRENT_VERSIONS=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases \
            | jq -r '.[].tag_name' \
            | sed 's/^v//' \
            | sort -V \
            | tr '\n' ' ')

          if [ -z "$OFFICIAL_VERSIONS" ] || [ -z "$LATEST_VERSION" ]; then
            echo "Can't fetch releases!"
            exit 1
          fi

          echo "OFFICIAL_VERSIONS=$OFFICIAL_VERSIONS" >> $GITHUB_OUTPUT
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSIONS=$CURRENT_VERSIONS" >> $GITHUB_OUTPUT

      - name: Determine versions to build
        id: determine_builds
        run: |
          VERSIONS_TO_BUILD=""
          for v in ${{ steps.versions.outputs.OFFICIAL_VERSIONS }}; do
            if [[ ! " ${{ steps.versions.outputs.CURRENT_VERSIONS }} " =~ " $v " ]]; then
              VERSIONS_TO_BUILD="$VERSIONS_TO_BUILD $v"
            fi
          done

          if [ -z "$VERSIONS_TO_BUILD" ]; then
            echo "No new versions to build."
            exit 0
          fi

          echo "VERSIONS_TO_BUILD=$VERSIONS_TO_BUILD" >> $GITHUB_OUTPUT

      - name: Trigger builds for new versions
        run: |
          for v in ${{ steps.determine_builds.outputs.VERSIONS_TO_BUILD }}; do
            if [ "$v" == "${{ steps.versions.outputs.LATEST_VERSION }}" ]; then
              LATEST_FLAG=true
            else
              LATEST_FLAG=false
            fi

            echo "Triggering build for version $v (LATEST=$LATEST_FLAG)"
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token ${{ secrets.GHCR_PAT }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-docker.yml/dispatches \
              -d "{\"ref\":\"main\",\"inputs\":{\"VERSION\":\"v$v\",\"LATEST\":\"$LATEST_FLAG\"}}"
          done